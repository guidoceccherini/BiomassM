geom_vline(xintercept = 1, linetype = "dashed", color = "white", size = 0.3, alpha = 0.5) +
scale_fill_gradient2(
low = "#d73027",
mid = "#ffffbf",
high = "#1a9850",
midpoint = 1,
limits = c(0.7, 1.3),
name = "Biomass Ratio"
) +
scale_x_continuous(limits = c(0.7, 1.3), breaks = seq(0.7, 1.3, 0.1)) +
facet_wrap(~ code, ncol = 4) +
theme_ridges(grid = FALSE) +
theme(
legend.position = "bottom",
strip.text = element_text(size = 12, face = "bold", color = "white"),
axis.text.y = element_text(size = 9, hjust = 1, color = "white"),
axis.text.x = element_text(size = 9, color = "white"),
axis.title = element_text(size = 11, face = "bold", color = "white"),
plot.title = element_text(hjust = 0.5, size = 14, face = "bold", color = "white"),
plot.subtitle = element_text(hjust = 0.5, size = 10, color = "white"),
panel.background = element_rect(fill = "black"),
plot.background = element_rect(fill = "black"),
strip.background = element_rect(fill = "grey20"),
legend.background = element_rect(fill = "black"),
legend.text = element_text(color = "white"),
legend.title = element_text(color = "white")
) +
labs(
title = "Forest Biomass Recovery Across European Biogeographic Regions",
subtitle = "From heavily disturbed to undisturbed forests",
x = "Biomass Ratio (Disturbed / Undisturbed)",
y = NULL
)
print(p_classic)
# ===== PLOT 3: Reversed order (undisturbed at top) =====
data_for_plot_reversed <- data_for_plot %>%
mutate(
severity_label_reversed = factor(
severity_label,
levels = rev(levels(severity_label))
)
)
p_reversed <- ggplot(data_for_plot_reversed, aes(x = biomass_ratio, y = severity_label_reversed, fill = severity_numeric)) +
stat_density_ridges(
aes(height = after_stat(density)),
geom = "density_ridges_gradient",
scale = 2.5,
rel_min_height = 0.01,
bandwidth = 0.02,
alpha = 0.8
) +
geom_vline(xintercept = 1, linetype = "dashed", color = "red", size = 0.5, alpha = 0.7) +
scale_fill_viridis_c(
option = "plasma",
name = "Disturbance\nIntensity",
breaks = c(1, 2, 3, 4, 5, 6),
labels = c("Very Heavy", "Heavy", "Moderate", "Mild", "Very Mild", "None"),
direction = 1
) +
scale_x_continuous(limits = c(0.7, 1.3), breaks = seq(0.7, 1.3, 0.1)) +
facet_wrap(~ code, ncol = 4) +
theme_ridges(grid = FALSE) +
theme(
legend.position = "bottom",
strip.text = element_text(size = 12, face = "bold"),
axis.text.y = element_text(size = 9, hjust = 1),
axis.text.x = element_text(size = 9),
axis.title = element_text(size = 11, face = "bold"),
plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
plot.subtitle = element_text(hjust = 0.5, size = 10)
) +
labs(
title = "Biomass Recovery Gradient: Undisturbed to Heavily Disturbed",
subtitle = "Distribution of Disturbed/Undisturbed biomass ratios",
x = "Biomass Ratio (Disturbed / Undisturbed)",
y = NULL
)
print(p_reversed)
# ===== PLOT 3: Reversed order (undisturbed at top) =====
data_for_plot_reversed <- data_for_plot %>%
mutate(
severity_label_reversed = factor(
severity_label,
levels = rev(levels(severity_label))
)
)
p_reversed <- ggplot(data_for_plot_reversed, aes(x = biomass_ratio, y = severity_label_reversed, fill = severity_numeric)) +
stat_density_ridges(
aes(height = after_stat(density)),
geom = "density_ridges_gradient",
scale = 2.5,
rel_min_height = 0.01,
bandwidth = 0.02,
alpha = 0.8
) +
geom_vline(xintercept = 1, linetype = "dashed", color = "red", size = 0.5, alpha = 0.7) +
scale_fill_viridis_c(
option = "plasma",
name = "Disturbance\nIntensity",
breaks = c(1, 2, 3, 4, 5, 6),
labels = c("Very Heavy", "Heavy", "Moderate", "Mild", "Very Mild", "None"),
direction = 1
) +
scale_x_continuous(limits = c(0.7, 1.3), breaks = seq(0.7, 1.3, 0.1)) +
facet_wrap(~ code, ncol = 4) +
theme_ridges(grid = FALSE) +
theme(
legend.position = "bottom",
strip.text = element_text(size = 12, face = "bold"),
axis.text.y = element_text(size = 9, hjust = 1),
axis.text.x = element_text(size = 9),
axis.title = element_text(size = 11, face = "bold"),
plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
plot.subtitle = element_text(hjust = 0.5, size = 10)
) +
labs(
title = "Biomass Recovery Gradient: Undisturbed to Heavily Disturbed",
subtitle = "Distribution of Disturbed/Undisturbed biomass ratios",
x = "Biomass Ratio (Disturbed / Undisturbed)",
y = NULL
)
print(p_reversed)
p_reversed <- ggplot(data_for_plot_reversed, aes(x = biomass_ratio, y = severity_label_reversed, fill = severity_numeric)) +
stat_density_ridges(
aes(height = after_stat(density)),
geom = "density_ridges_gradient",
scale = 2.5,
rel_min_height = 0.01,
bandwidth = 0.04,
alpha = 0.8
) +
geom_vline(xintercept = 1, linetype = "dashed", color = "red", size = 0.5, alpha = 0.7) +
scale_fill_viridis_c(
option = "plasma",
name = "Disturbance\nIntensity",
breaks = c(1, 2, 3, 4, 5, 6),
labels = c("Very Heavy", "Heavy", "Moderate", "Mild", "Very Mild", "None"),
direction = 1
) +
scale_x_continuous(limits = c(0.7, 1.3), breaks = seq(0.7, 1.3, 0.1)) +
facet_wrap(~ code, ncol = 4) +
theme_ridges(grid = FALSE) +
theme(
legend.position = "bottom",
strip.text = element_text(size = 12, face = "bold"),
axis.text.y = element_text(size = 9, hjust = 1),
axis.text.x = element_text(size = 9),
axis.title = element_text(size = 11, face = "bold"),
plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
plot.subtitle = element_text(hjust = 0.5, size = 10)
) +
labs(
title = "Biomass Recovery Gradient: Undisturbed to Heavily Disturbed",
subtitle = "Distribution of Disturbed/Undisturbed biomass ratios",
x = "Biomass Ratio (Disturbed / Undisturbed)",
y = NULL
)
print(p_reversed)
ggsave("Figures/joy_division_biomass_reversedratio2020.png", p_reversed,
width = 16, height = 10, dpi = 300)
# Summary statistics
summary_stats <- data_for_plot %>%
group_by(code, severity_label) %>%
summarise(
n = n(),
mean_ratio = mean(biomass_ratio, na.rm = TRUE),
median_ratio = median(biomass_ratio, na.rm = TRUE),
sd_ratio = sd(biomass_ratio, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(code, severity_label)
print(summary_stats)
library(tidyverse)
library(sf)
library(ggridges)
library(data.table)
library(viridis)
# Calculate sample sizes by region and severity
sample_sizes <- data_for_plot %>%
group_by(code, severity_label) %>%
summarise(n = n(), .groups = "drop")
# Identify regions with sufficient data (e.g., > 100 total observations)
regions_with_data <- sample_sizes %>%
group_by(code) %>%
summarise(total_n = sum(n), .groups = "drop") %>%
filter(total_n > 100) %>%  # Adjust threshold as needed
pull(code)
cat("Regions with sufficient data:", paste(regions_with_data, collapse = ", "), "\n")
# Filter data to keep only regions with sufficient data
data_filtered <- data_for_plot %>%
filter(code %in% regions_with_data)
# Also remove severity classes with very few observations per region
severity_counts <- data_filtered %>%
group_by(code, severity_label) %>%
summarise(n = n(), .groups = "drop") %>%
filter(n >= 20)  # At least 20 observations per severity class
# Keep only severity classes that appear in the filtered data
data_filtered <- data_filtered %>%
semi_join(severity_counts, by = c("code", "severity_label"))
cat("Total observations after filtering:", nrow(data_filtered), "\n")
p_classic <- ggplot(data_filtered, aes(x = biomass_ratio, y = severity_label, fill = after_stat(x))) +
stat_density_ridges(
geom = "density_ridges_gradient",
scale = 2.5,
rel_min_height = 0.01,
bandwidth = 0.02
) +
geom_vline(xintercept = 1, linetype = "dashed", color = "white", size = 0.5, alpha = 0.7) +
scale_fill_gradient2(
low = "#d73027",
mid = "#ffffbf",
high = "#1a9850",
midpoint = 1,
limits = c(0.7, 1.3),
name = "Biomass Ratio",
guide = guide_colorbar(
barwidth = 25,        # ENLARGED horizontal bar
barheight = 1.2,      # TALLER bar
title.position = "top",
title.hjust = 0.5,
frame.colour = "white",
ticks.colour = "white"
)
) +
scale_x_continuous(
limits = c(0.7, 1.3),
breaks = seq(0.7, 1.3, 0.1),
expand = c(0, 0)
) +
facet_wrap(~ code, ncol = 3, scales = "free_y") +  # Adjust ncol based on remaining regions
theme_ridges(grid = FALSE) +
theme(
legend.position = "bottom",
legend.box.spacing = unit(0.5, "cm"),
legend.margin = margin(t = 10, b = 5),
strip.text = element_text(size = 14, face = "bold", color = "white"),
axis.text.y = element_text(size = 10, hjust = 1, color = "white"),
axis.text.x = element_text(size = 10, color = "white"),
axis.title = element_text(size = 12, face = "bold", color = "white"),
axis.title.x = element_text(margin = margin(t = 10)),
plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white", margin = margin(b = 5)),
plot.subtitle = element_text(hjust = 0.5, size = 11, color = "white", margin = margin(b = 15)),
panel.background = element_rect(fill = "black"),
plot.background = element_rect(fill = "black"),
strip.background = element_rect(fill = "grey20"),
legend.background = element_rect(fill = "black"),
legend.text = element_text(color = "white", size = 10),
legend.title = element_text(color = "white", size = 11, face = "bold"),
panel.spacing = unit(1, "lines")
) +
labs(
title = "Forest Biomass Recovery Across European Biogeographic Regions",
subtitle = "From heavily disturbed to undisturbed forests",
x = "Biomass Ratio (Disturbed / Undisturbed)",
y = NULL
)
print(p_classic)
p_classic <- ggplot(data_filtered, aes(x = biomass_ratio, y = severity_label, fill = after_stat(x))) +
stat_density_ridges(
geom = "density_ridges_gradient",
scale = 2.5,
rel_min_height = 0.01,
bandwidth = 0.04
) +
geom_vline(xintercept = 1, linetype = "dashed", color = "white", size = 0.5, alpha = 0.7) +
scale_fill_gradient2(
low = "#d73027",
mid = "#ffffbf",
high = "#1a9850",
midpoint = 1,
limits = c(0.7, 1.3),
name = "Biomass Ratio",
guide = guide_colorbar(
barwidth = 25,        # ENLARGED horizontal bar
barheight = 1.2,      # TALLER bar
title.position = "top",
title.hjust = 0.5,
frame.colour = "white",
ticks.colour = "white"
)
) +
scale_x_continuous(
limits = c(0.7, 1.3),
breaks = seq(0.7, 1.3, 0.1),
expand = c(0, 0)
) +
facet_wrap(~ code, ncol = 3, scales = "free_y") +  # Adjust ncol based on remaining regions
theme_ridges(grid = FALSE) +
theme(
legend.position = "bottom",
legend.box.spacing = unit(0.5, "cm"),
legend.margin = margin(t = 10, b = 5),
strip.text = element_text(size = 14, face = "bold", color = "white"),
axis.text.y = element_text(size = 10, hjust = 1, color = "white"),
axis.text.x = element_text(size = 10, color = "white"),
axis.title = element_text(size = 12, face = "bold", color = "white"),
axis.title.x = element_text(margin = margin(t = 10)),
plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white", margin = margin(b = 5)),
plot.subtitle = element_text(hjust = 0.5, size = 11, color = "white", margin = margin(b = 15)),
panel.background = element_rect(fill = "black"),
plot.background = element_rect(fill = "black"),
strip.background = element_rect(fill = "grey20"),
legend.background = element_rect(fill = "black"),
legend.text = element_text(color = "white", size = 10),
legend.title = element_text(color = "white", size = 11, face = "bold"),
panel.spacing = unit(1, "lines")
) +
labs(
title = "Forest Biomass Recovery Across European Biogeographic Regions",
subtitle = "From heavily disturbed to undisturbed forests",
x = "Biomass Ratio (Disturbed / Undisturbed)",
y = NULL
)
print(p_classic)
p_classic <- ggplot(data_filtered, aes(x = biomass_ratio, y = severity_label, fill = after_stat(x))) +
stat_density_ridges(
geom = "density_ridges_gradient",
scale = 2.5,
rel_min_height = 0.01,
bandwidth = 0.04
) +
geom_vline(xintercept = 1, linetype = "dashed", color = "white", size = 0.5, alpha = 0.7) +
scale_fill_gradient2(
low = "#d73027",
mid = "#ffffbf",
high = "#1a9850",
midpoint = 1,
limits = c(0.7, 1.3),
name = "Biomass Ratio",
guide = guide_colorbar(
barwidth = 25,        # ENLARGED horizontal bar
barheight = 1.2,      # TALLER bar
title.position = "top",
title.hjust = 0.5,
frame.colour = "white",
ticks.colour = "white"
)
) +
scale_x_continuous(
limits = c(0.7, 1.3),
breaks = seq(0.7, 1.3, 0.1),
expand = c(0, 0)
) +
facet_wrap(~ code, ncol = 3, scales = "free_y") +  # Adjust ncol based on remaining regions
theme_ridges(grid = FALSE) +
theme(
legend.position = "bottom",
legend.box.spacing = unit(0.5, "cm"),
legend.margin = margin(t = 10, b = 5),
strip.text = element_text(size = 14, face = "bold", color = "white"),
axis.text.y = element_text(size = 10, hjust = 1, color = "white"),
axis.text.x = element_text(size = 10, color = "white"),
axis.title = element_text(size = 12, face = "bold", color = "white"),
axis.title.x = element_text(margin = margin(t = 10)),
plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "white", margin = margin(b = 5)),
plot.subtitle = element_text(hjust = 0.5, size = 11, color = "white", margin = margin(b = 15)),
panel.background = element_rect(fill = "black"),
plot.background = element_rect(fill = "black"),
strip.background = element_rect(fill = "grey20"),
legend.background = element_rect(fill = "black"),
legend.text = element_text(color = "white", size = 10),
legend.title = element_text(color = "white", size = 11, face = "bold"),
panel.spacing = unit(1, "lines")
) +
labs(
title = "Forest Biomass Recovery Across European Biogeographic Regions",
subtitle = "From heavily disturbed to undisturbed forests",
x = "Biomass Ratio (Disturbed / Undisturbed)",
y = NULL
)
print(p_classic)
ggsave("Figures/joy_division_biomassratio2020_filtered.png", p_classic,
width = 14, height = 10, dpi = 300, bg = "black")
# Remove severity levels that don't appear in any region
data_filtered_clean <- data_filtered %>%
group_by(severity_label) %>%
filter(n() > 50) %>%  # Keep severity classes with at least 50 total observations
ungroup() %>%
mutate(
severity_label = droplevels(severity_label)  # Remove unused factor levels
)
p_clean <- ggplot(data_filtered_clean, aes(x = biomass_ratio, y = severity_label, fill = after_stat(x))) +
stat_density_ridges(
geom = "density_ridges_gradient",
scale = 2.8,
rel_min_height = 0.01,
bandwidth = 0.02
) +
geom_vline(xintercept = 1, linetype = "dashed", color = "white", size = 0.5, alpha = 0.7) +
scale_fill_gradient2(
low = "#d73027",
mid = "#ffffbf",
high = "#1a9850",
midpoint = 1,
limits = c(0.7, 1.3),
name = "Biomass Ratio (Disturbed / Undisturbed)",
guide = guide_colorbar(
barwidth = 30,        # VERY WIDE horizontal bar
barheight = 1.5,
title.position = "top",
title.hjust = 0.5,
frame.colour = "white",
frame.linewidth = 0.5,
ticks.colour = "white",
ticks.linewidth = 0.5
)
) +
scale_x_continuous(
limits = c(0.7, 1.3),
breaks = seq(0.7, 1.3, 0.1),
expand = c(0.01, 0.01)
) +
facet_wrap(~ code, ncol = 3) +
theme_ridges(grid = FALSE) +
theme(
legend.position = "bottom",
legend.box.spacing = unit(1, "cm"),
legend.margin = margin(t = 15, b = 10),
strip.text = element_text(size = 15, face = "bold", color = "white"),
axis.text.y = element_text(size = 11, hjust = 1, color = "white", face = "bold"),
axis.text.x = element_text(size = 11, color = "white"),
axis.title = element_text(size = 13, face = "bold", color = "white"),
axis.title.x = element_text(margin = margin(t = 15)),
plot.title = element_text(hjust = 0.5, size = 18, face = "bold", color = "white", margin = margin(b = 5)),
plot.subtitle = element_text(hjust = 0.5, size = 12, color = "white", margin = margin(b = 20)),
panel.background = element_rect(fill = "black"),
plot.background = element_rect(fill = "black"),
plot.margin = margin(20, 20, 20, 20),
strip.background = element_rect(fill = "grey20"),
legend.background = element_rect(fill = "black"),
legend.text = element_text(color = "white", size = 11),
legend.title = element_text(color = "white", size = 12, face = "bold"),
panel.spacing = unit(1.5, "lines")
) +
labs(
title = "Forest Biomass Recovery Across European Biogeographic Regions",
subtitle = "Distribution of biomass ratios by disturbance severity",
x = "Biomass Ratio",
y = NULL
)
print(p_clean)
# Open hexagons
Hex_EU <- st_read('Data/grid_forest.gpkg')
Hex_EU <- Hex_EU %>% dplyr::filter(forest_count > 0)
if(!"hex_ID" %in% names(Hex_EU)) {
Hex_EU$hex_ID <- 1:nrow(Hex_EU)
}
Hex_EU
st_write(Hex_EU, 'Data/grid_forest_withID.gpkg', delete_dsn = TRUE)
st_write(Hex_EU |> select(-hex_id), 'Data/grid_forest_withID.gpkg', delete_dsn = TRUE)
library(terra)
library(tidyverse)
# Set your base directory containing all country folders
base_dir <- "/home/cecchgu/Downloads/13333034/"
# Get all country folders
country_folders <- list.dirs(base_dir, recursive = FALSE, full.names = TRUE)
cat("Found", length(country_folders), "country folders\n")
# Initialize lists to store file paths
disturbance_binary_files <- list()
undisturbed_files <- list()
# Process each country folder
for(folder in country_folders) {
country_name <- basename(folder)
cat("\nProcessing:", country_name, "\n")
# Find the disturbances and forest mask files
dist_file <- list.files(folder,
pattern = "annual_disturbances.*\\.tif$",
full.names = TRUE)
forest_file <- list.files(folder,
pattern = "forest_mask.*\\.tif$",
full.names = TRUE)
# Check if files exist
if(length(dist_file) == 0 || length(forest_file) == 0) {
warning(sprintf("Missing files in %s - skipping", country_name))
next
}
# Read rasters
Disturbances <- rast(dist_file[1])
ForestMask <- rast(forest_file[1])
# Extract layers for 2011-2019 (layers 27-35, assuming 1985 is layer 1)
disturbances_2011_2019 <- Disturbances[[27:34]]
# Create binary raster for 2011-2019 disturbances
disturbance_binary11_19 <- max(disturbances_2011_2019, na.rm = TRUE)
disturbance_binary11_19 <- ifel(disturbance_binary11_19 > 0, 1, 0)
# Create binary for ALL disturbances
disturbance_binaryAll <- max(Disturbances, na.rm = TRUE)
# Create undisturbed mask
undisturbed <- ifel(disturbance_binaryAll > 0, NA, ForestMask)
# Define output paths
output_dist <- file.path(folder, "disturbance_binary_2011_2018.tif")
# output_undist <- file.path(folder, "undisturbed.tif")
# Write outputs
writeRaster(disturbance_binary11_19,
output_dist,
overwrite = TRUE,
gdal = c("COMPRESS=LZW", "TILED=YES"))
# writeRaster(undisturbed,
#             output_undist,
#             overwrite = TRUE,
#             gdal = c("COMPRESS=LZW", "TILED=YES"))
# Store file paths for VRT creation
disturbance_binary_files <- c(disturbance_binary_files, output_dist)
# undisturbed_files <- c(undisturbed_files, output_undist)
cat(sprintf("  ✓ Saved: %s\n", basename(output_dist)))
# cat(sprintf("  ✓ Saved: %s\n", basename(output_undist)))
# Clean up memory
rm(Disturbances, ForestMask, disturbances_2011_2019,
disturbance_binary11_19, disturbance_binaryAll, undisturbed)
gc()
}
cat("\n=== Processing complete ===\n")
cat("Processed countries:", length(disturbance_binary_files), "\n")
